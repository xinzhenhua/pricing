<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西安装修报价系统 - Excel批量参数设置</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 保持原有的样式不变，只添加新的样式 */
        
        /* 新增样式：Excel批量设置区域 */
        .excel-section {
            margin: 20px 0;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .excel-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            background-color: var(--secondary-color);
            color: #000;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            background-color: #ffffff;
        }
        
        .upload-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .upload-status.success {
            background-color: rgba(0, 200, 0, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
            display: block;
        }
        
        .upload-status.error {
            background-color: rgba(255, 0, 0, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
            display: block;
        }
        
        /* 保持原有其他样式不变 */
        :root {
            --primary-color: #ffffff;
            --secondary-color: #ffffff;
            --background-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333333;
            --text-secondary: #aaaaaa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--primary-color);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 开场动画区域 */
        .hero-section {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .floating-keywords {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .keyword {
            position: absolute;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            opacity: 0;
            animation: float 20s infinite linear;
            white-space: nowrap;
            pointer-events: none;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .hero-content {
            text-align: center;
            z-index: 2;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 40px;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background-color: #ffffff;
            color: #000;
            transform: translateY(-2px);
        }
        
        /* 资料下载区域 */
        .download-section {
            padding: 60px 0;
            background-color: rgba(30, 30, 30, 0.8);
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 40px;
            color: var(--primary-color);
            font-size: 2rem;
        }
        
        .scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            padding: 20px 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scroll-container::-webkit-scrollbar {
            display: none;
        }
        
        .download-item {
            display: inline-block;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-right: 15px;
            min-width: 200px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .download-item:hover {
            border-color: var(--secondary-color);
            transform: translateY(-5px);
        }
        
        /* 报价表单区域 */
        .form-section {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 8px;
            margin: 40px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            background-color: #2a2a2a;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--primary-color);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* 整装报价区域 */
        .full-package-section {
            margin: 60px 0;
            text-align: center;
        }
        
        .package-cards {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .package-card {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            min-width: 0;
        }
        
        .package-card.highlight {
            border: 2px solid var(--secondary-color);
            transform: scale(1.02);
        }
        
        .package-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .package-total {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 20px 0;
            text-align: center;
        }
        
        .package-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 15px;
            line-height: 1.5;
        }
        
        /* 报价单区域 */
        .quote-section {
            margin: 60px 0;
        }
        
        .quote-cards {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .quote-card {
            flex: 1;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            min-width: 0;
        }
        
        .quote-card.highlight {
            border: 2px solid var(--secondary-color);
            transform: scale(1.02);
        }
        
        .quote-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .total-price {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 20px 0;
            text-align: center;
        }
        
        .toggle-details {
            background-color: transparent;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px auto;
            display: block;
            transition: all 0.3s ease;
        }
        
        .toggle-details:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .quote-details {
            display: none;
            margin-top: 20px;
        }
        
        .quote-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .quote-table th, .quote-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.4;
            word-break: break-word;
        }
        
        .quote-table th {
            background-color: #2a2a2a;
            font-weight: bold;
            color: var(--text-secondary);
        }
        
        /* 调整数量列宽，确保不换行 */
        .quantity-cell {
            white-space: nowrap;
            min-width: 80px;
        }
        
        /* 主材报价单 */
        .material-quote {
            margin-top: 60px;
        }
        
        .material-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .material-table th, .material-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.4;
            word-break: break-word;
        }
        
        .material-table th {
            background-color: #2a2a2a;
            font-weight: bold;
            color: var(--text-secondary);
        }
        
        .material-table input {
            width: 70px;
            padding: 6px;
            background-color: #2a2a2a;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--primary-color);
            font-size: 0.85rem;
        }
        
        /* 管理员设置页面 */
        .admin-section {
            display: none;
            padding: 40px 0;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--secondary-color);
            color: var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .params-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
            font-size: 0.9rem;
        }
        
        .params-table th, .params-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.4;
        }
        
        .params-table th {
            background-color: #2a2a2a;
        }
        
        .params-table input {
            width: 70px;
            padding: 6px;
            background-color: #2a2a2a;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--primary-color);
            font-size: 0.85rem;
        }
        
        .save-btn {
            background-color: var(--secondary-color);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* 历史记录区域 */
        .history-section {
            margin-top: 40px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .history-table th, .history-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.4;
            word-break: break-word;
        }
        
        .history-table th {
            background-color: #2a2a2a;
            font-weight: bold;
            color: var(--text-secondary);
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
            color: #888;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            border: 1px solid var(--border-color);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 15px;
            top: 10px;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--primary-color);
        }
        
        .modal-title {
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .admin-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(30, 30, 30, 0.8);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 100;
            font-size: 0.9rem;
        }
        
        .admin-btn:hover {
            background-color: rgba(50, 50, 50, 0.8);
        }
        
        .export-section {
            margin-top: 40px;
            text-align: center;
        }
        
        .export-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .export-controls select {
            width: 200px;
        }
        
        /* 电脑端适配 */
        @media (min-width: 1200px) {
            .container {
                max-width: 1600px;
            }
            
            .quote-table, .material-table {
                font-size: 1rem;
            }
            
            .quote-table th, .quote-table td,
            .material-table th, .material-table td {
                padding: 12px 10px;
            }
            
            .quote-card {
                padding: 30px;
            }
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .hero-subtitle {
                font-size: 1rem;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .quote-cards, .package-cards {
                flex-direction: column;
            }
            
            .quote-card, .package-card {
                padding: 15px;
            }
            
            .quote-table, .material-table, .history-table {
                display: block;
                overflow-x: auto;
                font-size: 0.8rem;
            }
            
            .quote-table th, .quote-table td,
            .material-table th, .material-table td,
            .history-table th, .history-table td {
                padding: 8px 6px;
            }
            
            .quantity-cell {
                min-width: 60px;
            }
            
            .params-table {
                font-size: 0.8rem;
            }
            
            .params-table th, .params-table td {
                padding: 8px 6px;
            }
            
            .admin-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .admin-header h2 {
                margin-bottom: 15px;
            }
            
            .total-price, .package-total {
                font-size: 2rem;
            }
            
            .export-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .export-controls select {
                width: 100%;
                max-width: 300px;
            }
            
            .excel-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 480px) {
            .quote-table, .material-table, .history-table {
                font-size: 0.75rem;
            }
            
            .quote-table th, .quote-table td,
            .material-table th, .material-table td,
            .history-table th, .history-table td {
                padding: 6px 4px;
            }
            
            .quantity-cell {
                min-width: 50px;
            }
            
            .material-table input {
                width: 60px;
                padding: 4px;
                font-size: 0.75rem;
            }
            
            .params-table {
                font-size: 0.75rem;
            }
            
            .params-table th, .params-table td {
                padding: 6px 4px;
            }
            
            .params-table input {
                width: 60px;
                padding: 4px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <button class="admin-btn" id="adminBtn">设置</button>
    
    <!-- 开场部分 -->
    <section class="hero-section">
        <div class="floating-keywords" id="floatingKeywords">
            <!-- 关键词将通过JS动态生成 -->
        </div>
        <div class="hero-content">
            <h1>在西安装修一套房子到底要花多少钱？</h1>
            <p class="hero-subtitle">精准报价 · 透明消费 · 避免陷阱 · 省心省力</p>
            <a href="#formSection" class="btn">一键报价</a>
        </div>
    </section>
    
    <!-- 资料下载部分 -->
    <section class="download-section">
        <div class="container">
            <h2 class="section-title">装修必备资料库</h2>
            <div class="scroll-container" id="scrollContainer">
                <!-- 下载项目将通过JS填充 -->
            </div>
        </div>
    </section>
    
    <!-- 报价表单部分 -->
    <section class="form-section" id="formSection">
        <div class="container">
            <h2 class="section-title">填写您的装修需求</h2>
            <form id="quoteForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="community">小区名称</label>
                        <input type="text" id="community" name="community" required>
                    </div>
                    <div class="form-group">
                        <label for="layout">户型</label>
                        <select id="layout" name="layout" required>
                            <option value="">请选择户型</option>
                            <option value="一室一厅">一室一厅</option>
                            <option value="两室一厅">两室一厅</option>
                            <option value="三室一厅">三室一厅</option>
                            <option value="三室两厅">三室两厅</option>
                            <option value="四室两厅">四室两厅</option>
                            <option value="复式">复式</option>
                            <option value="别墅">别墅</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="area">面积(㎡)</label>
                        <input type="number" id="area" name="area" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">联系电话</label>
                        <input type="tel" id="phone" name="phone" required>
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">请输入11位手机号码</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="floorTile">地砖规格</label>
                        <select id="floorTile" name="floorTile" required>
                            <option value="800*800">800*800</option>
                            <option value="750*1500">750*1500</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="wallTile">墙砖规格</label>
                        <select id="wallTile" name="wallTile" required>
                            <option value="400*800">400*800</option>
                            <option value="600*1200">600*1200</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="mainLight" name="mainLight">
                        是否做无主灯设计
                    </label>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">一键报价</button>
            </form>
        </div>
    </section>
    
    <!-- 整装报价部分 -->
    <section class="full-package-section" id="fullPackageSection" style="display: none;">
        <div class="container">
            <h2 class="section-title">整装报价</h2>
            <div class="package-cards">
                <div class="package-card">
                    <div class="package-header">
                        <h3>经济型整装</h3>
                    </div>
                    <div class="package-total" id="lowPackageTotal">¥0</div>
                    <p class="package-description">此整装报价包含：基础施工、主材、全屋定制柜<br>不包含：家具、家电、灯具、软装</p>
                </div>
                
                <div class="package-card highlight">
                    <div class="package-header">
                        <h3>品质型整装</h3>
                    </div>
                    <div class="package-total" id="midPackageTotal">¥0</div>
                    <p class="package-description">此整装报价包含：基础施工、主材、全屋定制柜<br>不包含：家具、家电、灯具、软装</p>
                </div>
                
                <div class="package-card">
                    <div class="package-header">
                        <h3>豪华型整装</h3>
                    </div>
                    <div class="package-total" id="highPackageTotal">¥0</div>
                    <p class="package-description">此整装报价包含：基础施工、主材、全屋定制柜<br>不包含：家具、家电、灯具、软装</p>
                </div>
            </div>
            
            <div class="export-section">
                <button class="btn" id="exportBtn">一键导出报价单</button>
            </div>
        </div>
    </section>
    
    <!-- 基础施工报价部分 -->
    <section class="quote-section" id="quoteSection" style="display: none;">
        <div class="container">
            <h2 class="section-title">基础施工报价单</h2>
            <div class="quote-cards">
                <div class="quote-card">
                    <div class="quote-header">
                        <h3>经济型装修</h3>
                        <p>性价比之选，满足基本居住需求</p>
                    </div>
                    <div class="total-price" id="lowTotal">¥0</div>
                    <button class="toggle-details" data-target="lowDetails">查看明细报价</button>
                    <div class="quote-details" id="lowDetails">
                        <table class="quote-table">
                            <thead>
                                <tr>
                                    <th>工程项目</th>
                                    <th class="quantity-cell">数量</th>
                                    <th>预算合计</th>
                                    <th>辅材品牌</th>
                                    <th>环保等级</th>
                                </tr>
                            </thead>
                            <tbody id="lowQuoteBody">
                                <!-- 报价明细将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="quote-card highlight">
                    <div class="quote-header">
                        <h3>品质型装修</h3>
                        <p>推荐选择，平衡品质与预算</p>
                    </div>
                    <div class="total-price" id="midTotal">¥0</div>
                    <button class="toggle-details" data-target="midDetails">查看明细报价</button>
                    <div class="quote-details" id="midDetails">
                        <table class="quote-table">
                            <thead>
                                <tr>
                                    <th>工程项目</th>
                                    <th class="quantity-cell">数量</th>
                                    <th>预算合计</th>
                                    <th>辅材品牌</th>
                                    <th>环保等级</th>
                                </tr>
                            </thead>
                            <tbody id="midQuoteBody">
                                <!-- 报价明细将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="quote-card">
                    <div class="quote-header">
                        <h3>豪华型装修</h3>
                        <p>高端配置，享受精致生活</p>
                    </div>
                    <div class="total-price" id="highTotal">¥0</div>
                    <button class="toggle-details" data-target="highDetails">查看明细报价</button>
                    <div class="quote-details" id="highDetails">
                        <table class="quote-table">
                            <thead>
                                <tr>
                                    <th>工程项目</th>
                                    <th class="quantity-cell">数量</th>
                                    <th>预算合计</th>
                                    <th>辅材品牌</th>
                                    <th>环保等级</th>
                                </tr>
                            </thead>
                            <tbody id="highQuoteBody">
                                <!-- 报价明细将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- 主材报价部分 -->
    <section class="quote-section material-quote" id="materialQuoteSection" style="display: none;">
        <div class="container">
            <h2 class="section-title">主材报价单</h2>
            <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">以下为估算价格，数量可根据实际情况调整</p>
            <div class="quote-cards">
                <div class="quote-card">
                    <div class="quote-header">
                        <h3>经济型主材</h3>
                    </div>
                    <div class="total-price" id="lowMaterialTotal">¥0</div>
                    <button class="toggle-details" data-target="lowMaterialDetails">查看明细报价</button>
                    <div class="quote-details" id="lowMaterialDetails">
                        <table class="material-table">
                            <thead>
                                <tr>
                                    <th>工程项目</th>
                                    <th class="quantity-cell">数量</th>
                                    <th>单价</th>
                                    <th>预算合计</th>
                                </tr>
                            </thead>
                            <tbody id="lowMaterialBody">
                                <!-- 主材报价明细将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="quote-card highlight">
                    <div class="quote-header">
                        <h3>品质型主材</h3>
                    </div>
                    <div class="total-price" id="midMaterialTotal">¥0</div>
                    <button class="toggle-details" data-target="midMaterialDetails">查看明细报价</button>
                    <div class="quote-details" id="midMaterialDetails">
                        <table class="material-table">
                            <thead>
                                <tr>
                                    <th>工程项目</th>
                                    <th class="quantity-cell">数量</th>
                                    <th>单价</th>
                                    <th>预算合计</th>
                                </tr>
                            </thead>
                            <tbody id="midMaterialBody">
                                <!-- 主材报价明细将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="quote-card">
                    <div class="quote-header">
                        <h3>豪华型主材</h3>
                    </div>
                    <div class="total-price" id="highMaterialTotal">¥0</div>
                    <button class="toggle-details" data-target="highMaterialDetails">查看明细报价</button>
                    <div class="quote-details" id="highMaterialDetails">
                        <table class="material-table">
                            <thead>
                                <tr>
                                    <th>工程项目</th>
                                    <th class="quantity-cell">数量</th>
                                    <th>单价</th>
                                    <th>预算合计</th>
                                </tr>
                            </thead>
                            <tbody id="highMaterialBody">
                                <!-- 主材报价明细将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- 管理员设置部分 -->
    <section class="admin-section" id="adminSection">
        <div class="container">
            <div class="admin-header">
                <h2 class="section-title">管理员设置</h2>
                <div>
                    <button class="btn" id="downloadTemplate">下载Excel模板</button>
                    <button class="btn" id="uploadExcel">上传Excel文件</button>
                    <button class="btn" id="backToMain">返回主页面</button>
                </div>
            </div>
            
            <!-- Excel批量设置区域 -->
            <div class="excel-section">
                <h3>Excel批量参数设置</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">通过Excel文件批量修改系统参数，请先下载模板，填写后上传</p>
                <div class="excel-controls">
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls">
                    <label for="excelFile" class="file-label">选择Excel文件</label>
                    <span id="fileName" style="color: var(--text-secondary);">未选择文件</span>
                </div>
                <div id="uploadStatus" class="upload-status"></div>
            </div>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="coefficients">数量系数</div>
                    <div class="tab" data-tab="high">高端参数</div>
                    <div class="tab" data-tab="mid">中端参数</div>
                    <div class="tab" data-tab="low">低端参数</div>
                    <div class="tab" data-tab="material">主材参数</div>
                    <div class="tab" data-tab="history">历史记录</div>
                </div>
                
                <div class="tab-content active" id="coefficients">
                    <h3>数量系数设置</h3>
                    <table class="params-table">
                        <thead>
                            <tr>
                                <th>工程项目</th>
                                <th>系数</th>
                            </tr>
                        </thead>
                        <tbody id="coefficientsBody">
                            <!-- 系数设置表格将通过JS填充 -->
                        </tbody>
                    </table>
                    <button class="save-btn" id="saveCoefficients">保存系数设置</button>
                </div>
                
                <div class="tab-content" id="high">
                    <h3>高端参数设置</h3>
                    <table class="params-table">
                        <thead>
                            <tr>
                                <th>材料类别</th>
                                <th>人工单价</th>
                                <th>辅料单价</th>
                                <th>辅材品牌</th>
                                <th>环保等级</th>
                            </tr>
                        </thead>
                        <tbody id="highParamsBody">
                            <!-- 高端参数表格将通过JS填充 -->
                        </tbody>
                    </table>
                    <button class="save-btn" id="saveHighParams">保存高端参数</button>
                </div>
                
                <div class="tab-content" id="mid">
                    <h3>中端参数设置</h3>
                    <table class="params-table">
                        <thead>
                            <tr>
                                <th>材料类别</th>
                                <th>人工单价</th>
                                <th>辅料单价</th>
                                <th>辅材品牌</th>
                                <th>环保等级</th>
                            </tr>
                        </thead>
                        <tbody id="midParamsBody">
                            <!-- 中端参数表格将通过JS填充 -->
                        </tbody>
                    </table>
                    <button class="save-btn" id="saveMidParams">保存中端参数</button>
                </div>
                
                <div class="tab-content" id="low">
                    <h3>低端参数设置</h3>
                    <table class="params-table">
                        <thead>
                            <tr>
                                <th>材料类别</th>
                                <th>人工单价</th>
                                <th>辅料单价</th>
                                <th>辅材品牌</th>
                                <th>环保等级</th>
                            </tr>
                        </thead>
                        <tbody id="lowParamsBody">
                            <!-- 低端参数表格将通过JS填充 -->
                        </tbody>
                    </table>
                    <button class="save-btn" id="saveLowParams">保存低端参数</button>
                </div>
                
                <div class="tab-content" id="material">
                    <h3>主材参数设置</h3>
                    <table class="params-table">
                        <thead>
                            <tr>
                                <th>材料类别</th>
                                <th>经济型单价</th>
                                <th>品质型单价</th>
                                <th>豪华型单价</th>
                            </tr>
                        </thead>
                        <tbody id="materialParamsBody">
                            <!-- 主材参数表格将通过JS填充 -->
                        </tbody>
                    </table>
                    <button class="save-btn" id="saveMaterialParams">保存主材参数</button>
                </div>
                
                <div class="tab-content" id="history">
                    <h3>历史报价记录</h3>
                    <div class="history-section">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>小区名称</th>
                                    <th>户型</th>
                                    <th>面积</th>
                                    <th>联系电话</th>
                                    <th>经济型报价</th>
                                    <th>品质型报价</th>
                                    <th>豪华型报价</th>
                                    <th>报价时间</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                <!-- 历史记录将通过JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <footer>
        <div class="container">
            <p>© 2023 西安装修报价系统 - 为您提供精准透明的装修成本分析</p>
        </div>
    </footer>
    
    <!-- 下载资料模态框 -->
    <div class="modal" id="downloadModal">
        <div class="modal-content">
            <span class="close" id="closeDownloadModal">&times;</span>
            <h3 class="modal-title">下载资料</h3>
            <p style="margin-bottom: 20px;">请输入您的手机号，即可下载资料</p>
            <div class="form-group">
                <input type="tel" id="downloadPhone" placeholder="请输入手机号">
            </div>
            <button class="btn" id="confirmDownload" style="width: 100%;">确认下载</button>
        </div>
    </div>
    
    <!-- 管理员登录模态框 -->
    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <span class="close" id="closeAdminLoginModal">&times;</span>
            <h3 class="modal-title">管理员登录</h3>
            <div class="form-group">
                <label for="adminPassword">管理员密码</label>
                <input type="password" id="adminPassword">
            </div>
            <button class="btn" id="loginBtn" style="width: 100%; margin-top: 10px;">登录</button>
        </div>
    </div>
    
    <!-- 导出报价单模态框 -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <span class="close" id="closeExportModal">&times;</span>
            <h3 class="modal-title">导出报价单</h3>
            <p style="margin-bottom: 20px;">请选择要导出的报价单类型</p>
            <div class="form-group">
                <label for="exportLevel">报价档次</label>
                <select id="exportLevel">
                    <option value="low">经济型</option>
                    <option value="mid">品质型</option>
                    <option value="high">豪华型</option>
                </select>
            </div>
            <div class="form-group">
                <label for="exportType">报价类型</label>
                <select id="exportType">
                    <option value="base">基础施工</option>
                    <option value="material">主材</option>
                    <option value="full">整装</option>
                </select>
            </div>
            <button class="btn" id="confirmExport" style="width: 100%; margin-top: 20px;">导出Excel</button>
        </div>
    </div>

    <script>
        // 初始数据 - 按照要求的顺序定义
        const initialData = {
            coefficients: {
                "水电改造": 0.9,
                "贴地砖800x800": 1,
                "贴墙砖400X800": 0.7,
                "贴地砖750X1500": 1,
                "贴墙砖600X1200": 0.7,
                "包立管 砌红砖": 0.03,
                "海棠角墙面拉毛": 1,
                "通铺通缝": 1,
                "窗帘盒": 0.03,
                "双眼皮": 0.5,
                "平顶": 0.037,
                "无主灯": 0.26,
                "墙固地固": 0.0074,
                "腻子粉": 2.6,
                "乳胶漆1底2面": 2.6,
                "厨卫阳台防水": 0.03,
                "材料搬运垃圾清理成品保护": 1
            },
            high: {
                "水电改造": {人工: 40, 辅料: 35, brand: "微法/吉博力", eco: "欧盟食品级认证"},
                "贴地砖800x800": {人工: 45, 辅料: 30, brand: "西卡", eco: "欧盟EC1标准"},
                "贴墙砖400X800": {人工: 50, 辅料: 30, brand: "西卡", eco: "欧盟EC1标准"},
                "贴地砖750X1500": {人工: 85, 辅料: 30, brand: "西卡", eco: "欧盟EC1标准"},
                "贴墙砖600X1200": {人工: 70, 辅料: 30, brand: "西卡", eco: "欧盟EC1标准"},
                "包立管 砌红砖": {人工: 260, 辅料: 100, brand: "海螺", eco: "国标GB175-2007"},
                "海棠角墙面拉毛": {人工: 20, 辅料: 10, brand: "西卡", eco: "欧盟EC1标准"},
                "通铺通缝": {人工: 20, 辅料: 10, brand: "西卡", eco: "欧盟EC1标准"},
                "窗帘盒": {人工: 350, 辅料: 100, brand: "吉野", eco: "国标GB/T9775-2008"},
                "双眼皮": {人工: 25, 辅料: 20, brand: "吉野", eco: "国标GB/T9775-2008"},
                "平顶": {人工: 400, 辅料: 100, brand: "吉野", eco: "国标GB/T9775-2008"},
                "无主灯": {人工: 65, 辅料: 35, brand: "吉野", eco: "国标GB/T9775-2008"},
                "墙固地固": {人工: 700, 辅料: 300, brand: "西卡", eco: "国标GB 18583-2008"},
                "腻子粉": {人工: 18, 辅料: 10, brand: "西卡", eco: "国标E0级"},
                "乳胶漆1底2面": {人工: 6, 辅料: 6, brand: "大师漆", eco: "GREENGUARD金级认证"},
                "厨卫阳台防水": {人工: 500, 辅料: 0, brand: "西卡", eco: "欧盟EC1标准"},
                "材料搬运垃圾清理成品保护": {人工: 15, 辅料: 5, brand: "-", eco: "-"}
            },
            mid: {
                "水电改造": {人工: 35, 辅料: 30, brand: "法兰特/伟星", eco: "国标认证"},
                "贴地砖800x800": {人工: 40, 辅料: 25, brand: "德高", eco: "国标认证"},
                "贴墙砖400X800": {人工: 45, 辅料: 25, brand: "德高", eco: "国标认证"},
                "贴地砖750X1500": {人工: 75, 辅料: 25, brand: "德高", eco: "国标认证"},
                "贴墙砖600X1200": {人工: 60, 辅料: 25, brand: "德高", eco: "国标认证"},
                "包立管 砌红砖": {人工: 230, 辅料: 80, brand: "海螺", eco: "国标GB175-2007"},
                "海棠角墙面拉毛": {人工: 18, 辅料: 8, brand: "德高", eco: "国标认证"},
                "通铺通缝": {人工: 18, 辅料: 8, brand: "德高", eco: "国标认证"},
                "窗帘盒": {人工: 300, 辅料: 80, brand: "伊蔚娜", eco: "欧盟CE/A+双认证"},
                "双眼皮": {人工: 22, 辅料: 18, brand: "伊蔚娜", eco: "欧盟CE/A+双认证"},
                "平顶": {人工: 350, 辅料: 80, brand: "伊蔚娜", eco: "欧盟CE/A+双认证"},
                "无主灯": {人工: 55, 辅料: 30, brand: "伊蔚娜", eco: "欧盟CE/A+双认证"},
                "墙固地固": {人工: 600, 辅料: 250, brand: "西卡", eco: "国标GB 18583-2008"},
                "腻子粉": {人工: 16, 辅料: 8, brand: "西卡", eco: "国标E0级"},
                "乳胶漆1底2面": {人工: 5, 辅料: 5, brand: "佐敦", eco: "BS7750健康标准"},
                "厨卫阳台防水": {人工: 450, 辅料: 0, brand: "西卡", eco: "欧盟EC1标准"},
                "材料搬运垃圾清理成品保护": {人工: 13, 辅料: 4, brand: "-", eco: "-"}
            },
            low: {
                "水电改造": {人工: 30, 辅料: 25, brand: "日丰/伟星", eco: "行业标准认证"},
                "贴地砖800x800": {人工: 35, 辅料: 20, brand: "水泥沙混合", eco: "基础标准"},
                "贴墙砖400X800": {人工: 40, 辅料: 20, brand: "水泥沙混合", eco: "基础标准"},
                "贴地砖750X1500": {人工: 65, 辅料: 20, brand: "水泥沙混合", eco: "基础标准"},
                "贴墙砖600X1200": {人工: 50, 辅料: 20, brand: "水泥沙混合", eco: "基础标准"},
                "包立管 砌红砖": {人工: 200, 辅料: 60, brand: "海螺", eco: "国标GB175-2007"},
                "海棠角墙面拉毛": {人工: 15, 辅料: 6, brand: "水泥沙混合", eco: "基础标准"},
                "通铺通缝": {人工: 15, 辅料: 6, brand: "水泥沙混合", eco: "基础标准"},
                "窗帘盒": {人工: 250, 辅料: 60, brand: "泰山", eco: "国标GB/T9775-2008"},
                "双眼皮": {人工: 18, 辅料: 15, brand: "泰山", eco: "国标GB/T9775-2008"},
                "平顶": {人工: 300, 辅料: 60, brand: "泰山", eco: "国标GB/T9775-2008"},
                "无主灯": {人工: 45, 辅料: 25, brand: "泰山", eco: "国标GB/T9775-2008"},
                "墙固地固": {人工: 500, 辅料: 200, brand: "汇邦", eco: "CQC节能认证"},
                "腻子粉": {人工: 14, 辅料: 6, brand: "奥维", eco: "国标GB185822008"},
                "乳胶漆1底2面": {人工: 4, 辅料: 4, brand: "可耐美", eco: "BS7750健康标准"},
                "厨卫阳台防水": {人工: 400, 辅料: 0, brand: "西卡", eco: "欧盟EC1标准"},
                "材料搬运垃圾清理成品保护": {人工: 10, 辅料: 3, brand: "-", eco: "-"}
            },
            material: {
                "地砖800x800": {low: 45, mid: 65, high: 120},
                "墙砖400X800": {low: 16, mid: 25, high: 45},
                "地砖750X1500": {low: 80, mid: 100, high: 180},
                "墙砖600X1200": {low: 35, mid: 50, high: 85},
                "合金门": {low: 850, mid: 850, high: 1700},
                "推拉门": {low: 3000, mid: 3000, high: 3000},
                "全屋定制衣柜": {low: 500, mid: 700, high: 28000},
                "橱柜": {low: 7000, mid: 7000, high: 7000},
                "铝扣板": {low: 70, mid: 100, high: 2565},
                "开关面板": {low: 1000, mid: 1000, high: 1000},
                "美缝": {low: 4000, mid: 4000, high: 4000},
                "卫浴": {low: 6400, mid: 6400, high: 6400},
                "风暖浴霸 集成灯": {low: 1500, mid: 1500, high: 1500},
                "卧室木门": {low: 3000, mid: 3000, high: 3000},
                "踢脚线": {low: 1500, mid: 1500, high: 1500},
                "窗套 垭口 入户门套": {low: 2000, mid: 2000, high: 2000},
                "石材": {low: 1500, mid: 1500, high: 1500},
                "水槽碗碟拉篮": {low: 1000, mid: 1000, high: 1000},
                "冷热水角阀地漏": {low: 600, mid: 600, high: 600}
            },
            materialCoefficients: {
                "地砖800x800": 1.65,
                "墙砖400X800": 2.16,
                "地砖750X1500": 0.91,
                "墙砖600X1200": 0.96,
                "全屋定制衣柜": 0.3,
                "橱柜": 0.052,
                "铝扣板": 0.19,
                "合金门": 2,
                "推拉门": 1,
                "开关面板": 1,
                "美缝": 1,
                "卫浴": 2,
                "风暖浴霸 集成灯": 2,
                "卧室木门": 3,
                "踢脚线": 1,
                "窗套 垭口 入户门套": 1,
                "石材": 1,
                "水槽碗碟拉篮": 1,
                "冷热水角阀地漏": 1
            }
        };

        // 装修痛点关键词
        const painKeywords = [
            "报价陷阱", "增项不断", "材料以次充好", "工期拖延", 
            "预算超支", "工艺不规范", "环保不达标", "售后无门",
            "合同漏洞", "设计不合理", "施工质量差", "沟通困难",
            "隐蔽工程问题", "材料浪费", "验收标准不明确", "维权困难"
        ];

        // 下载资料列表
        const downloadFiles = [
            "《全屋材料品牌大全》",
            "《水电布局细节特点》",
            "《智能家电清单》",
            "《超全开关插座表》",
            "《2026新版装修避坑资料大全》",
            "《装修流程》",
            "《装修前必做的准备》",
            "《水电攻略》",
            "《装修砍价攻略》",
            "《二手房收房注意事项》",
            "《35个施工工序》",
            "《装修公司调研考察表》",
            "《装修全流程验收标准》",
            "《主材购买和进场时间》",
            "《超详细建材购买时间表》",
            "《西安装修公司黑名单》",
            "《装修合同陷阱避坑指南》",
            "《环保材料选购指南》"
        ];

        // 当前报价数据
        let currentQuoteData = null;

        // 基础施工项目顺序
        const baseConstructionOrder = [
            "水电改造",
            "贴地砖800x800", 
            "贴墙砖400X800",
            "贴地砖750X1500",
            "贴墙砖600X1200",
            "包立管 砌红砖",
            "海棠角墙面拉毛",
            "通铺通缝",
            "窗帘盒",
            "双眼皮",
            "平顶",
            "无主灯",
            "墙固地固",
            "腻子粉",
            "乳胶漆1底2面",
            "厨卫阳台防水",
            "材料搬运垃圾清理成品保护"
        ];

        // 主材项目顺序
        const mainMaterialOrder = [
            "地砖800x800",
            "墙砖400X800",
            "地砖750X1500",
            "墙砖600X1200",
            "合金门",
            "推拉门",
            "全屋定制衣柜",
            "橱柜",
            "铝扣板",
            "开关面板",
            "美缝",
            "卫浴",
            "风暖浴霸 集成灯",
            "卧室木门",
            "踢脚线",
            "窗套 垭口 入户门套",
            "石材",
            "水槽碗碟拉篮",
            "冷热水角阀地漏"
        ];

        // 初始化数据到LeanCloud
        async function initializeData() {
            try {
                // 检查SystemConfig是否已存在数据
                const SystemConfig = AV.Object.extend('SystemConfig');
                const query = new AV.Query('SystemConfig');
                let config = await query.first();
                
                if (!config) {
                    // 创建初始数据
                    console.log('创建初始SystemConfig数据...');
                    config = new SystemConfig();
                    
                    config.set('coefficients', initialData.coefficients);
                    config.set('high', initialData.high);
                    config.set('mid', initialData.mid);
                    config.set('low', initialData.low);
                    config.set('material', initialData.material);
                    config.set('materialCoefficients', initialData.materialCoefficients);
                    
                    await config.save();
                    console.log('初始SystemConfig数据已保存到LeanCloud');
                }
                
                // 检查Quote类是否存在（通过尝试查询一条记录）
                const Quote = AV.Object.extend('Quote');
                const quoteQuery = new AV.Query('Quote');
                quoteQuery.limit(1);
                await quoteQuery.find();
                
                console.log('LeanCloud数据初始化完成');
                return true;
            } catch (error) {
                console.error('初始化数据失败:', error);
                // 如果是因为类不存在，我们尝试创建一条记录来隐式创建类
                if (error.code === 101 || error.code === 1) { // Class doesn't exist
                    try {
                        console.log('尝试创建必要的Class...');
                        // 创建SystemConfig
                        const SystemConfig = AV.Object.extend('SystemConfig');
                        const config = new SystemConfig();
                        config.set('coefficients', initialData.coefficients);
                        await config.save();
                        
                        // 创建Quote
                        const Quote = AV.Object.extend('Quote');
                        const quote = new Quote();
                        quote.set('test', 'init');
                        await quote.save();
                        
                        console.log('Class创建成功，现在重新初始化数据...');
                        return await initializeData();
                    } catch (createError) {
                        console.error('创建Class失败:', createError);
                        return false;
                    }
                }
                return false;
            }
        }

        // 获取数据
        async function getData() {
            try {
                const query = new AV.Query('SystemConfig');
                const config = await query.first();
                
                if (config) {
                    return {
                        coefficients: config.get('coefficients') || initialData.coefficients,
                        high: config.get('high') || initialData.high,
                        mid: config.get('mid') || initialData.mid,
                        low: config.get('low') || initialData.low,
                        material: config.get('material') || initialData.material,
                        materialCoefficients: config.get('materialCoefficients') || initialData.materialCoefficients
                    };
                } else {
                    // 如果没有数据，返回初始数据
                    console.log('使用本地初始数据');
                    return initialData;
                }
            } catch (error) {
                console.error('获取数据失败:', error);
                // 如果是因为类不存在，尝试初始化
                if (error.code === 101) {
                    await initializeData();
                    return initialData;
                }
                return initialData;
            }
        }

        // 保存数据
        async function saveData(key, data) {
            try {
                const query = new AV.Query('SystemConfig');
                let config = await query.first();
                
                if (config) {
                    config.set(key, data);
                    await config.save();
                    console.log(`${key} 数据保存成功`);
                    return true;
                } else {
                    // 如果没有配置记录，创建新的
                    const SystemConfig = AV.Object.extend('SystemConfig');
                    config = new SystemConfig();
                    
                    // 设置所有数据
                    config.set('coefficients', initialData.coefficients);
                    config.set('high', initialData.high);
                    config.set('mid', initialData.mid);
                    config.set('low', initialData.low);
                    config.set('material', initialData.material);
                    config.set('materialCoefficients', initialData.materialCoefficients);
                    
                    // 更新特定的key
                    config.set(key, data);
                    
                    await config.save();
                    console.log(`新的SystemConfig创建成功，${key} 数据已保存`);
                    return true;
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                alert('保存失败: ' + error.message);
                return false;
            }
        }

        // 检查是否已有相同小区和电话的报价
        async function checkExistingQuote(community, phone) {
            try {
                const Quote = AV.Object.extend('Quote');
                const query = new AV.Query(Quote);
                query.equalTo('community', community);
                query.equalTo('phone', phone);
                const quotes = await query.find();
                
                return quotes.length > 0;
            } catch (error) {
                console.error('检查报价记录失败:', error);
                return false;
            }
        }

        // 保存报价到LeanCloud
        async function saveQuoteToCloud(quoteData) {
            try {
                const Quote = AV.Object.extend('Quote');
                const quote = new Quote();
                
                quote.set('community', quoteData.community);
                quote.set('layout', quoteData.layout);
                quote.set('area', quoteData.area);
                quote.set('phone', quoteData.phone);
                quote.set('floorTile', quoteData.floorTile);
                quote.set('wallTile', quoteData.wallTile);
                quote.set('mainLight', quoteData.mainLight);
                quote.set('lowTotal', quoteData.lowTotal);
                quote.set('midTotal', quoteData.midTotal);
                quote.set('highTotal', quoteData.highTotal);
                quote.set('lowMaterialTotal', quoteData.lowMaterialTotal);
                quote.set('midMaterialTotal', quoteData.midMaterialTotal);
                quote.set('highMaterialTotal', quoteData.highMaterialTotal);
                
                const result = await quote.save();
                console.log('报价已保存到云端，ID:', result.id);
                return result.id;
            } catch (error) {
                console.error('保存报价失败:', error);
                // 如果是因为Quote类不存在，我们尝试创建一条记录来隐式创建类
                if (error.code === 101) {
                    try {
                        const Quote = AV.Object.extend('Quote');
                        const testQuote = new Quote();
                        testQuote.set('test', 'init');
                        await testQuote.save();
                        console.log('Quote类创建成功，重新尝试保存报价...');
                        return await saveQuoteToCloud(quoteData);
                    } catch (createError) {
                        console.error('创建Quote类失败:', createError);
                    }
                }
                return null;
            }
        }

        // 获取历史报价
        async function getHistoryQuotes() {
            try {
                const Quote = AV.Object.extend('Quote');
                const query = new AV.Query(Quote);
                query.descending('createdAt');
                query.limit(50); // 限制返回数量
                const quotes = await query.find();
                
                return quotes.map(quote => ({
                    id: quote.id,
                    community: quote.get('community'),
                    layout: quote.get('layout'),
                    area: quote.get('area'),
                    phone: quote.get('phone'),
                    lowTotal: quote.get('lowTotal'),
                    midTotal: quote.get('midTotal'),
                    highTotal: quote.get('highTotal'),
                    createdAt: quote.get('createdAt')
                }));
            } catch (error) {
                console.error('获取历史报价失败:', error);
                // 如果是因为类不存在，返回空数组
                if (error.code === 101) {
                    return [];
                }
                return [];
            }
        }

        // 创建漂浮关键词
        function createFloatingKeywords() {
            const container = document.getElementById('floatingKeywords');
            
            painKeywords.forEach((keyword, index) => {
                const element = document.createElement('div');
                element.className = 'keyword';
                element.textContent = keyword;
                element.style.left = `${Math.random() * 90}%`;
                element.style.animationDelay = `${Math.random() * 20}s`;
                element.style.fontSize = `${20 + Math.random() * 20}px`;
                container.appendChild(element);
            });
        }

        // 初始化下载列表
        function initializeDownloads() {
            const scrollContainer = document.getElementById('scrollContainer');
            scrollContainer.innerHTML = '';
            
            downloadFiles.forEach(file => {
                const downloadItem = document.createElement('div');
                downloadItem.className = 'download-item';
                downloadItem.innerHTML = `
                    <span>${file}</span>
                `;
                downloadItem.addEventListener('click', () => {
                    document.getElementById('downloadModal').style.display = 'flex';
                    document.getElementById('downloadPhone').value = document.getElementById('phone').value || '';
                });
                scrollContainer.appendChild(downloadItem);
            });
        }

        // 计算报价
        async function calculateQuote(area, floorTile, wallTile, mainLight, level) {
            const data = await getData();
            const coefficients = data.coefficients;
            const params = data[level];
            
            let total = 0;
            const quoteItems = [];
            
            // 按照指定顺序计算每个项目的费用
            for (const item of baseConstructionOrder) {
                const coefficient = coefficients[item];
                if (!coefficient) continue;
                
                let quantity = area * coefficient;
                let cost = 0;
                
                // 特殊处理地砖和墙砖选择
                if (item.includes("地砖") && item.includes("800x800") && floorTile === "750*1500") {
                    continue; // 跳过不匹配的选项
                }
                if (item.includes("地砖") && item.includes("750X1500") && floorTile === "800*800") {
                    continue; // 跳过不匹配的选项
                }
                if (item.includes("墙砖") && item.includes("400X800") && wallTile === "600*1200") {
                    continue; // 跳过不匹配的选项
                }
                if (item.includes("墙砖") && item.includes("600X1200") && wallTile === "400*800") {
                    continue; // 跳过不匹配的选项
                }
                
                // 特殊处理无主灯
                if (item.includes("无主灯") && !mainLight) {
                    continue; // 如果不做无主灯，跳过此项
                }
                
                if (params[item]) {
                    cost = quantity * (params[item].人工 + params[item].辅料);
                    total += cost;
                    quoteItems.push({
                        name: item,
                        quantity: Math.round(quantity * 100) / 100,
                        cost: Math.round(cost),
                        brand: params[item].brand,
                        eco: params[item].eco
                    });
                }
            }
            
            return { total: Math.round(total), items: quoteItems };
        }

        // 计算主材报价
        async function calculateMaterialQuote(area, floorTile, wallTile, level) {
            const data = await getData();
            const coefficients = data.materialCoefficients;
            const params = data.material;
            
            let total = 0;
            const quoteItems = [];
            
            // 按照指定顺序计算每个项目的费用
            for (const item of mainMaterialOrder) {
                const coefficient = coefficients[item];
                if (!coefficient) continue;
                
                let quantity = coefficient;
                
                // 只有地砖、墙砖、全屋定制衣柜、橱柜、铝扣板是根据面积系数计算
                const areaRelatedItems = ['地砖800x800', '墙砖400X800', '地砖750X1500', '墙砖600X1200', '全屋定制衣柜', '橱柜', '铝扣板'];
                if (areaRelatedItems.includes(item)) {
                    quantity = area * coefficient;
                }
                
                let price = params[item][level];
                
                // 根据用户选择的规格，将未选中的地砖墙砖价格设为0
                if (item === "地砖800x800" && floorTile === "750*1500") {
                    price = 0;
                }
                if (item === "地砖750X1500" && floorTile === "800*800") {
                    price = 0;
                }
                if (item === "墙砖400X800" && wallTile === "600*1200") {
                    price = 0;
                }
                if (item === "墙砖600X1200" && wallTile === "400*800") {
                    price = 0;
                }
                
                let cost = quantity * price;
                
                total += cost;
                quoteItems.push({
                    name: item,
                    quantity: Math.round(quantity * 100) / 100,
                    price: price,
                    cost: Math.round(cost)
                });
            }
            
            return { total: Math.round(total), items: quoteItems };
        }

        // 显示报价
        async function displayQuote(area, floorTile, wallTile, mainLight) {
            const lowQuote = await calculateQuote(area, floorTile, wallTile, mainLight, 'low');
            const midQuote = await calculateQuote(area, floorTile, wallTile, mainLight, 'mid');
            const highQuote = await calculateQuote(area, floorTile, wallTile, mainLight, 'high');
            
            // 更新总价
            document.getElementById('lowTotal').textContent = '¥' + lowQuote.total;
            document.getElementById('midTotal').textContent = '¥' + midQuote.total;
            document.getElementById('highTotal').textContent = '¥' + highQuote.total;
            
            // 更新报价明细
            updateQuoteTable('lowQuoteBody', lowQuote.items);
            updateQuoteTable('midQuoteBody', midQuote.items);
            updateQuoteTable('highQuoteBody', highQuote.items);
            
            // 计算并显示主材报价
            const lowMaterialQuote = await calculateMaterialQuote(area, floorTile, wallTile, 'low');
            const midMaterialQuote = await calculateMaterialQuote(area, floorTile, wallTile, 'mid');
            const highMaterialQuote = await calculateMaterialQuote(area, floorTile, wallTile, 'high');
            
            document.getElementById('lowMaterialTotal').textContent = '¥' + lowMaterialQuote.total;
            document.getElementById('midMaterialTotal').textContent = '¥' + midMaterialQuote.total;
            document.getElementById('highMaterialTotal').textContent = '¥' + highMaterialQuote.total;
            
            updateMaterialTable('lowMaterialBody', lowMaterialQuote.items, 'low');
            updateMaterialTable('midMaterialBody', midMaterialQuote.items, 'mid');
            updateMaterialTable('highMaterialBody', highMaterialQuote.items, 'high');
            
            // 计算并显示整装报价
            const lowPackageTotal = lowQuote.total + lowMaterialQuote.total;
            const midPackageTotal = midQuote.total + midMaterialQuote.total;
            const highPackageTotal = highQuote.total + highMaterialQuote.total;
            
            document.getElementById('lowPackageTotal').textContent = '¥' + lowPackageTotal;
            document.getElementById('midPackageTotal').textContent = '¥' + midPackageTotal;
            document.getElementById('highPackageTotal').textContent = '¥' + highPackageTotal;
            
            // 显示报价区域
            document.getElementById('fullPackageSection').style.display = 'block';
            document.getElementById('quoteSection').style.display = 'block';
            document.getElementById('materialQuoteSection').style.display = 'block';
            
            // 保存当前报价数据
            currentQuoteData = {
                community: document.getElementById('community').value,
                layout: document.getElementById('layout').value,
                area: area,
                phone: document.getElementById('phone').value,
                floorTile: floorTile,
                wallTile: wallTile,
                mainLight: mainLight,
                lowTotal: lowQuote.total,
                midTotal: midQuote.total,
                highTotal: highQuote.total,
                lowMaterialTotal: lowMaterialQuote.total,
                midMaterialTotal: midMaterialQuote.total,
                highMaterialTotal: highMaterialQuote.total,
                lowPackageTotal: lowPackageTotal,
                midPackageTotal: midPackageTotal,
                highPackageTotal: highPackageTotal,
                baseQuoteItems: {
                    low: lowQuote.items,
                    mid: midQuote.items,
                    high: highQuote.items
                },
                materialQuoteItems: {
                    low: lowMaterialQuote.items,
                    mid: midMaterialQuote.items,
                    high: highMaterialQuote.items
                }
            };
            
            // 自动保存报价到历史记录
            const id = await saveQuoteToCloud(currentQuoteData);
            if (id) {
                console.log('报价已自动保存到历史记录');
            } else {
                console.error('保存报价失败');
            }
            
            // 滚动到报价区域
            document.getElementById('fullPackageSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 更新报价表格 - 保持原有顺序
        function updateQuoteTable(tableId, items) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';
            
            // 按照指定顺序显示项目
            for (const itemName of baseConstructionOrder) {
                const item = items.find(i => i.name === itemName);
                if (item) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td class="quantity-cell">${item.quantity}</td>
                        <td>¥${item.cost}</td>
                        <td>${item.brand}</td>
                        <td>${item.eco}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
        }

        // 更新主材报价表格 - 保持原有顺序
        function updateMaterialTable(tableId, items, level) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';
            
            // 按照指定顺序显示项目
            for (const itemName of mainMaterialOrder) {
                const item = items.find(i => i.name === itemName);
                if (item) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td class="quantity-cell"><input type="number" value="${item.quantity}" min="0" step="0.01" data-item="${item.name}" data-level="${level}"></td>
                        <td>¥${item.price}</td>
                        <td>¥<span class="item-total" data-item="${item.name}" data-level="${level}">${item.cost}</span></td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            
            // 添加数量修改事件监听
            const inputs = tableBody.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', updateMaterialTotal);
            });
        }

        // 更新主材总价
        async function updateMaterialTotal(e) {
            const input = e.target;
            const itemName = input.getAttribute('data-item');
            const level = input.getAttribute('data-level');
            const quantity = parseFloat(input.value);
            
            const data = await getData();
            let price = data.material[itemName][level];
            
            // 根据用户选择的规格，将未选中的地砖墙砖价格设为0
            const floorTile = document.getElementById('floorTile').value;
            const wallTile = document.getElementById('wallTile').value;
            
            if (itemName === "地砖800x800" && floorTile === "750*1500") {
                price = 0;
            }
            if (itemName === "地砖750X1500" && floorTile === "800*800") {
                price = 0;
            }
            if (itemName === "墙砖400X800" && wallTile === "600*1200") {
                price = 0;
            }
            if (itemName === "墙砖600X1200" && wallTile === "400*800") {
                price = 0;
            }
            
            const total = quantity * price;
            
            // 更新单项总价
            const totalElement = document.querySelector(`.item-total[data-item="${itemName}"][data-level="${level}"]`);
            totalElement.textContent = Math.round(total);
            
            // 更新档次总价
            let levelTotal = 0;
            const inputs = document.querySelectorAll(`#${level}MaterialBody input`);
            inputs.forEach(input => {
                const item = input.getAttribute('data-item');
                const qty = parseFloat(input.value);
                let prc = data.material[item][level];
                
                // 根据用户选择的规格，将未选中的地砖墙砖价格设为0
                if (item === "地砖800x800" && floorTile === "750*1500") {
                    prc = 0;
                }
                if (item === "地砖750X1500" && floorTile === "800*800") {
                    prc = 0;
                }
                if (item === "墙砖400X800" && wallTile === "600*1200") {
                    prc = 0;
                }
                if (item === "墙砖600X1200" && wallTile === "400*800") {
                    prc = 0;
                }
                
                levelTotal += qty * prc;
            });
            
            document.getElementById(`${level}MaterialTotal`).textContent = '¥' + Math.round(levelTotal);
            
            // 更新整装报价
            const baseTotal = parseInt(document.getElementById(`${level}Total`).textContent.replace('¥', ''));
            const packageTotal = baseTotal + Math.round(levelTotal);
            document.getElementById(`${level}PackageTotal`).textContent = '¥' + packageTotal;
            
            // 更新当前报价数据
            if (currentQuoteData) {
                currentQuoteData[`${level}MaterialTotal`] = Math.round(levelTotal);
                currentQuoteData[`${level}PackageTotal`] = packageTotal;
            }
        }

        // 显示历史报价
        async function displayHistoryQuotes() {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">加载中...</td></tr>';
            
            const quotes = await getHistoryQuotes();
            
            if (quotes.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">暂无历史报价记录</td></tr>';
                return;
            }
            
            historyBody.innerHTML = '';
            
            quotes.forEach(quote => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${quote.community || '-'}</td>
                    <td>${quote.layout || '-'}</td>
                    <td>${quote.area || 0}㎡</td>
                    <td>${quote.phone || '-'}</td>
                    <td>¥${quote.lowTotal || 0}</td>
                    <td>¥${quote.midTotal || 0}</td>
                    <td>¥${quote.highTotal || 0}</td>
                    <td>${quote.createdAt ? new Date(quote.createdAt).toLocaleString() : '-'}</td>
                `;
                historyBody.appendChild(row);
            });
        }

        // 验证电话号码
        function validatePhone(phone) {
            const phoneRegex = /^1[3-9]\d{9}$/;
            return phoneRegex.test(phone);
        }

        // 导出报价单为Excel
        async function exportQuoteToExcel(level, type) {
            // 获取当前时间
            const now = new Date();
            const timeString = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日${now.getHours()}时${now.getMinutes()}分`;
            
            // 创建新的工作簿
            const wb = XLSX.utils.book_new();
            
            // 根据选择的类型导出不同的报价单
            if (type === 'base') {
                // 基础施工报价单
                const baseData = [
                    ['西安装修报价系统 - 基础施工报价单'],
                    [''],
                    ['小区名称:', currentQuoteData.community],
                    ['户型:', currentQuoteData.layout],
                    ['面积:', `${currentQuoteData.area}㎡`],
                    ['联系电话:', currentQuoteData.phone],
                    ['报价档次:', level === 'low' ? '经济型' : level === 'mid' ? '品质型' : '豪华型'],
                    ['报价时间:', timeString],
                    [''],
                    ['基础施工总价:', `¥${currentQuoteData[`${level}Total`]}`],
                    [''],
                    ['工程项目', '数量', '预算合计(元)', '辅材品牌', '环保等级']
                ];
                
                // 添加基础施工明细
                const baseItems = currentQuoteData.baseQuoteItems[level];
                baseItems.forEach(item => {
                    baseData.push([
                        item.name,
                        item.quantity,
                        `¥${item.cost}`,
                        item.brand,
                        item.eco
                    ]);
                });
                
                // 创建工作表
                const ws = XLSX.utils.aoa_to_sheet(baseData);
                
                // 设置列宽
                const colWidths = [
                    {wch: 30}, // 工程项目
                    {wch: 10}, // 数量
                    {wch: 15}, // 预算合计
                    {wch: 20}, // 辅材品牌
                    {wch: 20}  // 环保等级
                ];
                ws['!cols'] = colWidths;
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, ws, '基础施工报价单');
                
            } else if (type === 'material') {
                // 主材报价单
                const materialData = [
                    ['西安装修报价系统 - 主材报价单'],
                    [''],
                    ['小区名称:', currentQuoteData.community],
                    ['户型:', currentQuoteData.layout],
                    ['面积:', `${currentQuoteData.area}㎡`],
                    ['联系电话:', currentQuoteData.phone],
                    ['报价档次:', level === 'low' ? '经济型' : level === 'mid' ? '品质型' : '豪华型'],
                    ['报价时间:', timeString],
                    [''],
                    ['主材总价:', `¥${currentQuoteData[`${level}MaterialTotal`]}`],
                    [''],
                    ['工程项目', '数量', '单价(元)', '预算合计(元)']
                ];
                
                // 添加主材明细
                const materialItems = currentQuoteData.materialQuoteItems[level];
                materialItems.forEach(item => {
                    materialData.push([
                        item.name,
                        item.quantity,
                        `¥${item.price}`,
                        `¥${item.cost}`
                    ]);
                });
                
                // 创建工作表
                const ws = XLSX.utils.aoa_to_sheet(materialData);
                
                // 设置列宽
                const colWidths = [
                    {wch: 30}, // 工程项目
                    {wch: 10}, // 数量
                    {wch: 15}, // 单价
                    {wch: 15}  // 预算合计
                ];
                ws['!cols'] = colWidths;
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, ws, '主材报价单');
                
            } else if (type === 'full') {
                // 整装报价单 - 包含基础施工和主材
                
                // 基础施工工作表
                const baseData = [
                    ['西安装修报价系统 - 整装报价单 - 基础施工部分'],
                    [''],
                    ['小区名称:', currentQuoteData.community],
                    ['户型:', currentQuoteData.layout],
                    ['面积:', `${currentQuoteData.area}㎡`],
                    ['联系电话:', currentQuoteData.phone],
                    ['报价档次:', level === 'low' ? '经济型' : level === 'mid' ? '品质型' : '豪华型'],
                    ['报价时间:', timeString],
                    [''],
                    ['基础施工总价:', `¥${currentQuoteData[`${level}Total`]}`],
                    [''],
                    ['工程项目', '数量', '预算合计(元)', '辅材品牌', '环保等级']
                ];
                
                // 添加基础施工明细
                const baseItems = currentQuoteData.baseQuoteItems[level];
                baseItems.forEach(item => {
                    baseData.push([
                        item.name,
                        item.quantity,
                        `¥${item.cost}`,
                        item.brand,
                        item.eco
                    ]);
                });
                
                // 创建工作表
                const baseWs = XLSX.utils.aoa_to_sheet(baseData);
                
                // 设置列宽
                const baseColWidths = [
                    {wch: 30}, // 工程项目
                    {wch: 10}, // 数量
                    {wch: 15}, // 预算合计
                    {wch: 20}, // 辅材品牌
                    {wch: 20}  // 环保等级
                ];
                baseWs['!cols'] = baseColWidths;
                
                // 主材工作表
                const materialData = [
                    ['西安装修报价系统 - 整装报价单 - 主材部分'],
                    [''],
                    ['小区名称:', currentQuoteData.community],
                    ['户型:', currentQuoteData.layout],
                    ['面积:', `${currentQuoteData.area}㎡`],
                    ['联系电话:', currentQuoteData.phone],
                    ['报价档次:', level === 'low' ? '经济型' : level === 'mid' ? '品质型' : '豪华型'],
                    ['报价时间:', timeString],
                    [''],
                    ['主材总价:', `¥${currentQuoteData[`${level}MaterialTotal`]}`],
                    [''],
                    ['工程项目', '数量', '单价(元)', '预算合计(元)']
                ];
                
                // 添加主材明细
                const materialItems = currentQuoteData.materialQuoteItems[level];
                materialItems.forEach(item => {
                    materialData.push([
                        item.name,
                        item.quantity,
                        `¥${item.price}`,
                        `¥${item.cost}`
                    ]);
                });
                
                // 创建工作表
                const materialWs = XLSX.utils.aoa_to_sheet(materialData);
                
                // 设置列宽
                const materialColWidths = [
                    {wch: 30}, // 工程项目
                    {wch: 10}, // 数量
                    {wch: 15}, // 单价
                    {wch: 15}  // 预算合计
                ];
                materialWs['!cols'] = materialColWidths;
                
                // 汇总工作表
                const summaryData = [
                    ['西安装修报价系统 - 整装报价单 - 汇总'],
                    [''],
                    ['小区名称:', currentQuoteData.community],
                    ['户型:', currentQuoteData.layout],
                    ['面积:', `${currentQuoteData.area}㎡`],
                    ['联系电话:', currentQuoteData.phone],
                    ['报价档次:', level === 'low' ? '经济型' : level === 'mid' ? '品质型' : '豪华型'],
                    ['报价时间:', timeString],
                    [''],
                    ['整装总价:', `¥${currentQuoteData[`${level}PackageTotal`]}`],
                    [''],
                    ['项目类别', '金额(元)'],
                    ['基础施工', `¥${currentQuoteData[`${level}Total`]}`],
                    ['主材', `¥${currentQuoteData[`${level}MaterialTotal`]}`],
                    [''],
                    ['说明:'],
                    ['此整装报价包含：基础施工、主材、全屋定制柜'],
                    ['不包含：家具、家电、灯具、软装']
                ];
                
                // 创建工作表
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                
                // 设置列宽
                const summaryColWidths = [
                    {wch: 30}, // 项目类别
                    {wch: 15}  // 金额
                ];
                summaryWs['!cols'] = summaryColWidths;
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, baseWs, '基础施工');
                XLSX.utils.book_append_sheet(wb, materialWs, '主材');
                XLSX.utils.book_append_sheet(wb, summaryWs, '汇总');
            }
            
            // 生成文件名
            const levelText = level === 'low' ? '经济' : level === 'mid' ? '品质' : '豪华';
            const typeText = type === 'base' ? '基础施工' : type === 'material' ? '主材' : '整装';
            const fileName = `${currentQuoteData.community}，${currentQuoteData.area}㎡，${levelText}${typeText}报价单，${timeString}.xlsx`;
            
            // 导出Excel文件
            XLSX.writeFile(wb, fileName);
        }

        // 管理员设置功能
        function initializeAdminPanel() {
            const adminBtn = document.getElementById('adminBtn');
            const backToMain = document.getElementById('backToMain');
            const adminSection = document.getElementById('adminSection');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // 打开管理员设置页面
            adminBtn.addEventListener('click', () => {
                document.getElementById('adminLoginModal').style.display = 'flex';
            });
            
            // 返回主页面
            backToMain.addEventListener('click', () => {
                adminSection.style.display = 'none';
                document.querySelector('.hero-section').style.display = 'flex';
                document.querySelector('.download-section').style.display = 'block';
                document.querySelector('.form-section').style.display = 'block';
                window.scrollTo(0, 0);
            });
            
            // 选项卡切换
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // 如果切换到历史记录选项卡，加载历史记录
                    if (tabId === 'history') {
                        displayHistoryQuotes();
                    }
                });
            });
            
            // 保存按钮事件
            document.getElementById('saveCoefficients').addEventListener('click', saveCoefficients);
            document.getElementById('saveHighParams').addEventListener('click', () => saveParams('high'));
            document.getElementById('saveMidParams').addEventListener('click', () => saveParams('mid'));
            document.getElementById('saveLowParams').addEventListener('click', () => saveParams('low'));
            document.getElementById('saveMaterialParams').addEventListener('click', saveMaterialParams);
            
            // Excel批量设置功能
            initializeExcelBatchSettings();
        }

        // 初始化Excel批量设置功能
        function initializeExcelBatchSettings() {
            const downloadTemplateBtn = document.getElementById('downloadTemplate');
            const excelFileInput = document.getElementById('excelFile');
            const fileNameSpan = document.getElementById('fileName');
            
            // 下载Excel模板
            downloadTemplateBtn.addEventListener('click', downloadExcelTemplate);
            
            // 文件选择事件
            excelFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    fileNameSpan.textContent = file.name;
                    readExcelFile(file);
                }
            });
        }

        // 下载Excel模板
        async function downloadExcelTemplate() {
            const data = await getData();
            
            // 创建新的工作簿
            const wb = XLSX.utils.book_new();
            
            // 1. 系数工作表
            const coefficientsData = [
                ['西安装修报价系统 - 参数批量设置模板'],
                [''],
                ['说明：请勿修改第一列的项目名称，只需修改对应的数值'],
                [''],
                ['系数设置'],
                ['工程项目', '系数']
            ];
            
            // 添加基础施工系数
            for (const item of baseConstructionOrder) {
                if (data.coefficients[item] !== undefined) {
                    coefficientsData.push([item, data.coefficients[item]]);
                }
            }
            
            // 添加主材系数
            coefficientsData.push(['', '']);
            coefficientsData.push(['主材系数', '']);
            for (const item of mainMaterialOrder) {
                if (data.materialCoefficients[item] !== undefined) {
                    coefficientsData.push([item, data.materialCoefficients[item]]);
                }
            }
            
            // 创建工作表
            const coefficientsWs = XLSX.utils.aoa_to_sheet(coefficientsData);
            
            // 设置列宽
            coefficientsWs['!cols'] = [
                {wch: 30}, // 工程项目
                {wch: 15}  // 系数
            ];
            
            // 2. 高端参数工作表
            const highData = [
                ['西安装修报价系统 - 参数批量设置模板'],
                [''],
                ['说明：请勿修改第一列的项目名称，只需修改对应的数值'],
                [''],
                ['高端参数设置'],
                ['材料类别', '人工单价', '辅料单价', '辅材品牌', '环保等级']
            ];
            
            for (const item of baseConstructionOrder) {
                if (data.high[item]) {
                    highData.push([
                        item,
                        data.high[item].人工,
                        data.high[item].辅料,
                        data.high[item].brand,
                        data.high[item].eco
                    ]);
                }
            }
            
            const highWs = XLSX.utils.aoa_to_sheet(highData);
            highWs['!cols'] = [
                {wch: 30}, // 材料类别
                {wch: 15}, // 人工单价
                {wch: 15}, // 辅料单价
                {wch: 20}, // 辅材品牌
                {wch: 20}  // 环保等级
            ];
            
            // 3. 中端参数工作表
            const midData = [
                ['西安装修报价系统 - 参数批量设置模板'],
                [''],
                ['说明：请勿修改第一列的项目名称，只需修改对应的数值'],
                [''],
                ['中端参数设置'],
                ['材料类别', '人工单价', '辅料单价', '辅材品牌', '环保等级']
            ];
            
            for (const item of baseConstructionOrder) {
                if (data.mid[item]) {
                    midData.push([
                        item,
                        data.mid[item].人工,
                        data.mid[item].辅料,
                        data.mid[item].brand,
                        data.mid[item].eco
                    ]);
                }
            }
            
            const midWs = XLSX.utils.aoa_to_sheet(midData);
            midWs['!cols'] = [
                {wch: 30}, // 材料类别
                {wch: 15}, // 人工单价
                {wch: 15}, // 辅料单价
                {wch: 20}, // 辅材品牌
                {wch: 20}  // 环保等级
            ];
            
            // 4. 低端参数工作表
            const lowData = [
                ['西安装修报价系统 - 参数批量设置模板'],
                [''],
                ['说明：请勿修改第一列的项目名称，只需修改对应的数值'],
                [''],
                ['低端参数设置'],
                ['材料类别', '人工单价', '辅料单价', '辅材品牌', '环保等级']
            ];
            
            for (const item of baseConstructionOrder) {
                if (data.low[item]) {
                    lowData.push([
                        item,
                        data.low[item].人工,
                        data.low[item].辅料,
                        data.low[item].brand,
                        data.low[item].eco
                    ]);
                }
            }
            
            const lowWs = XLSX.utils.aoa_to_sheet(lowData);
            lowWs['!cols'] = [
                {wch: 30}, // 材料类别
                {wch: 15}, // 人工单价
                {wch: 15}, // 辅料单价
                {wch: 20}, // 辅材品牌
                {wch: 20}  // 环保等级
            ];
            
            // 5. 主材参数工作表
            const materialData = [
                ['西安装修报价系统 - 参数批量设置模板'],
                [''],
                ['说明：请勿修改第一列的项目名称，只需修改对应的数值'],
                [''],
                ['主材参数设置'],
                ['材料类别', '经济型单价', '品质型单价', '豪华型单价']
            ];
            
            for (const item of mainMaterialOrder) {
                if (data.material[item]) {
                    materialData.push([
                        item,
                        data.material[item].low,
                        data.material[item].mid,
                        data.material[item].high
                    ]);
                }
            }
            
            const materialWs = XLSX.utils.aoa_to_sheet(materialData);
            materialWs['!cols'] = [
                {wch: 30}, // 材料类别
                {wch: 15}, // 经济型单价
                {wch: 15}, // 品质型单价
                {wch: 15}  // 豪华型单价
            ];
            
            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, coefficientsWs, '系数');
            XLSX.utils.book_append_sheet(wb, highWs, '高端参数');
            XLSX.utils.book_append_sheet(wb, midWs, '中端参数');
            XLSX.utils.book_append_sheet(wb, lowWs, '低端参数');
            XLSX.utils.book_append_sheet(wb, materialWs, '主材参数');
            
            // 生成文件名
            const now = new Date();
            const timeString = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
            const fileName = `西安装修报价系统参数模板_${timeString}.xlsx`;
            
            // 导出Excel文件
            XLSX.writeFile(wb, fileName);
        }

        // 读取Excel文件
        function readExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 解析各个工作表
                    const result = parseExcelData(workbook);
                    
                    if (result.success) {
                        // 更新页面上的表格
                        updateAdminTables(result.data);
                        
                        // 显示成功消息
                        const statusElement = document.getElementById('uploadStatus');
                        statusElement.textContent = 'Excel文件解析成功，数据已填充到表格中，请点击保存按钮保存更改';
                        statusElement.className = 'upload-status success';
                    } else {
                        throw new Error(result.message || '解析Excel文件失败');
                    }
                } catch (error) {
                    console.error('读取Excel文件失败:', error);
                    const statusElement = document.getElementById('uploadStatus');
                    statusElement.textContent = '读取Excel文件失败: ' + error.message;
                    statusElement.className = 'upload-status error';
                }
            };
            
            reader.onerror = function() {
                const statusElement = document.getElementById('uploadStatus');
                statusElement.textContent = '读取文件时发生错误';
                statusElement.className = 'upload-status error';
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 解析Excel数据
        function parseExcelData(workbook) {
            const result = {
                success: true,
                data: {},
                message: ''
            };
            
            try {
                // 1. 解析系数工作表
                if (workbook.Sheets['系数']) {
                    const coefficientsData = XLSX.utils.sheet_to_json(workbook.Sheets['系数'], {header: 1});
                    
                    // 找到"系数设置"行
                    let startRow = -1;
                    for (let i = 0; i < coefficientsData.length; i++) {
                        if (coefficientsData[i][0] === '系数设置') {
                            startRow = i + 1; // 下一行开始是数据
                            break;
                        }
                    }
                    
                    if (startRow === -1) {
                        result.success = false;
                        result.message = '在"系数"工作表中未找到"系数设置"标题';
                        return result;
                    }
                    
                    // 解析基础施工系数
                    result.data.coefficients = {};
                    for (let i = startRow; i < coefficientsData.length; i++) {
                        const row = coefficientsData[i];
                        if (!row || !row[0]) continue;
                        
                        // 如果遇到空行，可能是主材系数的开始
                        if (row[0] === '') break;
                        
                        // 跳过标题行
                        if (row[0] === '工程项目') continue;
                        
                        result.data.coefficients[row[0]] = parseFloat(row[1]) || 0;
                    }
                    
                    // 查找主材系数
                    let materialStartRow = -1;
                    for (let i = startRow; i < coefficientsData.length; i++) {
                        if (coefficientsData[i][0] === '主材系数') {
                            materialStartRow = i + 1;
                            break;
                        }
                    }
                    
                    if (materialStartRow !== -1) {
                        result.data.materialCoefficients = {};
                        for (let i = materialStartRow; i < coefficientsData.length; i++) {
                            const row = coefficientsData[i];
                            if (!row || !row[0]) continue;
                            
                            result.data.materialCoefficients[row[0]] = parseFloat(row[1]) || 0;
                        }
                    }
                }
                
                // 2. 解析高端参数工作表
                if (workbook.Sheets['高端参数']) {
                    const highData = XLSX.utils.sheet_to_json(workbook.Sheets['高端参数'], {header: 1});
                    
                    let startRow = -1;
                    for (let i = 0; i < highData.length; i++) {
                        if (highData[i][0] === '高端参数设置') {
                            startRow = i + 1;
                            break;
                        }
                    }
                    
                    if (startRow !== -1) {
                        result.data.high = {};
                        for (let i = startRow; i < highData.length; i++) {
                            const row = highData[i];
                            if (!row || !row[0]) continue;
                            
                            // 跳过标题行
                            if (row[0] === '材料类别') continue;
                            
                            result.data.high[row[0]] = {
                                人工: parseFloat(row[1]) || 0,
                                辅料: parseFloat(row[2]) || 0,
                                brand: row[3] || '',
                                eco: row[4] || ''
                            };
                        }
                    }
                }
                
                // 3. 解析中端参数工作表
                if (workbook.Sheets['中端参数']) {
                    const midData = XLSX.utils.sheet_to_json(workbook.Sheets['中端参数'], {header: 1});
                    
                    let startRow = -1;
                    for (let i = 0; i < midData.length; i++) {
                        if (midData[i][0] === '中端参数设置') {
                            startRow = i + 1;
                            break;
                        }
                    }
                    
                    if (startRow !== -1) {
                        result.data.mid = {};
                        for (let i = startRow; i < midData.length; i++) {
                            const row = midData[i];
                            if (!row || !row[0]) continue;
                            
                            // 跳过标题行
                            if (row[0] === '材料类别') continue;
                            
                            result.data.mid[row[0]] = {
                                人工: parseFloat(row[1]) || 0,
                                辅料: parseFloat(row[2]) || 0,
                                brand: row[3] || '',
                                eco: row[4] || ''
                            };
                        }
                    }
                }
                
                // 4. 解析低端参数工作表
                if (workbook.Sheets['低端参数']) {
                    const lowData = XLSX.utils.sheet_to_json(workbook.Sheets['低端参数'], {header: 1});
                    
                    let startRow = -1;
                    for (let i = 0; i < lowData.length; i++) {
                        if (lowData[i][0] === '低端参数设置') {
                            startRow = i + 1;
                            break;
                        }
                    }
                    
                    if (startRow !== -1) {
                        result.data.low = {};
                        for (let i = startRow; i < lowData.length; i++) {
                            const row = lowData[i];
                            if (!row || !row[0]) continue;
                            
                            // 跳过标题行
                            if (row[0] === '材料类别') continue;
                            
                            result.data.low[row[0]] = {
                                人工: parseFloat(row[1]) || 0,
                                辅料: parseFloat(row[2]) || 0,
                                brand: row[3] || '',
                                eco: row[4] || ''
                            };
                        }
                    }
                }
                
                // 5. 解析主材参数工作表
                if (workbook.Sheets['主材参数']) {
                    const materialData = XLSX.utils.sheet_to_json(workbook.Sheets['主材参数'], {header: 1});
                    
                    let startRow = -1;
                    for (let i = 0; i < materialData.length; i++) {
                        if (materialData[i][0] === '主材参数设置') {
                            startRow = i + 1;
                            break;
                        }
                    }
                    
                    if (startRow !== -1) {
                        result.data.material = {};
                        for (let i = startRow; i < materialData.length; i++) {
                            const row = materialData[i];
                            if (!row || !row[0]) continue;
                            
                            // 跳过标题行
                            if (row[0] === '材料类别') continue;
                            
                            result.data.material[row[0]] = {
                                low: parseFloat(row[1]) || 0,
                                mid: parseFloat(row[2]) || 0,
                                high: parseFloat(row[3]) || 0
                            };
                        }
                    }
                }
                
                return result;
            } catch (error) {
                result.success = false;
                result.message = error.message;
                return result;
            }
        }

        // 更新管理员表格
        function updateAdminTables(data) {
            // 更新系数表格
            if (data.coefficients) {
                const inputs = document.querySelectorAll('#coefficientsBody input');
                inputs.forEach(input => {
                    const item = input.getAttribute('data-item');
                    if (data.coefficients[item] !== undefined) {
                        input.value = data.coefficients[item];
                    }
                });
            }
            
            // 更新高端参数表格
            if (data.high) {
                updateParamsTable('highParamsBody', data.high);
            }
            
            // 更新中端参数表格
            if (data.mid) {
                updateParamsTable('midParamsBody', data.mid);
            }
            
            // 更新低端参数表格
            if (data.low) {
                updateParamsTable('lowParamsBody', data.low);
            }
            
            // 更新主材参数表格
            if (data.material) {
                updateMaterialParamsTable('materialParamsBody', data.material);
            }
            
            // 更新主材系数
            if (data.materialCoefficients) {
                const inputs = document.querySelectorAll('#coefficientsBody input');
                inputs.forEach(input => {
                    const item = input.getAttribute('data-item');
                    if (data.materialCoefficients[item] !== undefined) {
                        input.value = data.materialCoefficients[item];
                    }
                });
            }
        }

        // 更新参数表格
        function updateParamsTable(tableId, params) {
            const inputs = document.querySelectorAll(`#${tableId} input`);
            inputs.forEach(input => {
                const item = input.getAttribute('data-item');
                const type = input.getAttribute('data-type');
                
                if (params[item] && params[item][type] !== undefined) {
                    input.value = params[item][type];
                }
            });
        }

        // 更新主材参数表格
        function updateMaterialParamsTable(tableId, params) {
            const inputs = document.querySelectorAll(`#${tableId} input`);
            inputs.forEach(input => {
                const item = input.getAttribute('data-item');
                const type = input.getAttribute('data-type');
                
                if (params[item] && params[item][type] !== undefined) {
                    input.value = params[item][type];
                }
            });
        }

        // 加载管理员数据
        async function loadAdminData() {
            const data = await getData();
            
            // 加载系数设置
            const coefficientsBody = document.getElementById('coefficientsBody');
            coefficientsBody.innerHTML = '';
            
            for (const [item, coefficient] of Object.entries(data.coefficients)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item}</td>
                    <td><input type="number" value="${coefficient}" step="0.01" data-item="${item}"></td>
                `;
                coefficientsBody.appendChild(row);
            }
            
            // 加载主材系数
            for (const [item, coefficient] of Object.entries(data.materialCoefficients)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item} (主材)</td>
                    <td><input type="number" value="${coefficient}" step="0.01" data-item="${item}"></td>
                `;
                coefficientsBody.appendChild(row);
            }
            
            // 加载参数设置
            loadParamsTable('highParamsBody', data.high);
            loadParamsTable('midParamsBody', data.mid);
            loadParamsTable('lowParamsBody', data.low);
            
            // 加载主材参数
            loadMaterialTable('materialParamsBody', data.material);
        }

        // 加载参数表格
        function loadParamsTable(tableId, params) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';
            
            for (const [item, values] of Object.entries(params)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item}</td>
                    <td><input type="number" value="${values.人工}" data-item="${item}" data-type="人工"></td>
                    <td><input type="number" value="${values.辅料}" data-item="${item}" data-type="辅料"></td>
                    <td><input type="text" value="${values.brand}" data-item="${item}" data-type="brand"></td>
                    <td><input type="text" value="${values.eco}" data-item="${item}" data-type="eco"></td>
                `;
                tableBody.appendChild(row);
            }
        }

        // 加载主材参数表格
        function loadMaterialTable(tableId, params) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';
            
            for (const [item, values] of Object.entries(params)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item}</td>
                    <td><input type="number" value="${values.low}" data-item="${item}" data-type="low"></td>
                    <td><input type="number" value="${values.mid}" data-item="${item}" data-type="mid"></td>
                    <td><input type="number" value="${values.high}" data-item="${item}" data-type="high"></td>
                `;
                tableBody.appendChild(row);
            }
        }

        // 保存系数设置
        async function saveCoefficients() {
            const data = await getData();
            const inputs = document.querySelectorAll('#coefficientsBody input');
            
            inputs.forEach(input => {
                const item = input.getAttribute('data-item');
                const value = parseFloat(input.value);
                
                // 判断是基础施工系数还是主材系数
                if (data.coefficients.hasOwnProperty(item)) {
                    data.coefficients[item] = value;
                } else if (data.materialCoefficients.hasOwnProperty(item)) {
                    data.materialCoefficients[item] = value;
                }
            });
            
            // 保存基础施工系数
            const success1 = await saveData('coefficients', data.coefficients);
            // 保存主材系数
            const success2 = await saveData('materialCoefficients', data.materialCoefficients);
            
            if (success1 && success2) {
                alert('系数设置已保存！');
            } else {
                alert('保存失败，请重试！');
            }
        }

        // 保存参数设置
        async function saveParams(level) {
            const data = await getData();
            const inputs = document.querySelectorAll(`#${level}ParamsBody input`);
            
            inputs.forEach(input => {
                const item = input.getAttribute('data-item');
                const type = input.getAttribute('data-type');
                const value = type === '人工' || type === '辅料' ? parseFloat(input.value) : input.value;
                
                if (!data[level][item]) {
                    data[level][item] = {};
                }
                
                data[level][item][type] = value;
            });
            
            const success = await saveData(level, data[level]);
            if (success) {
                alert(`${level === 'high' ? '高端' : level === 'mid' ? '中端' : '低端'}参数已保存！`);
            } else {
                alert('保存失败，请重试！');
            }
        }

        // 保存主材参数
        async function saveMaterialParams() {
            const data = await getData();
            const inputs = document.querySelectorAll('#materialParamsBody input');
            
            inputs.forEach(input => {
                const item = input.getAttribute('data-item');
                const type = input.getAttribute('data-type');
                const value = parseFloat(input.value);
                
                if (!data.material[item]) {
                    data.material[item] = {};
                }
                
                data.material[item][type] = value;
            });
            
            const success = await saveData('material', data.material);
            if (success) {
                alert('主材参数已保存！');
            } else {
                alert('保存失败，请重试！');
            }
        }

        // 初始化下载模态框
        function initializeDownloadModal() {
            const downloadModal = document.getElementById('downloadModal');
            const closeDownloadModal = document.getElementById('closeDownloadModal');
            const confirmDownload = document.getElementById('confirmDownload');
            
            closeDownloadModal.addEventListener('click', () => {
                downloadModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === downloadModal) {
                    downloadModal.style.display = 'none';
                }
            });
            
            confirmDownload.addEventListener('click', () => {
                const phone = document.getElementById('downloadPhone').value;
                if (phone && validatePhone(phone)) {
                    alert('专业客服即将加您微信，免费发送给您，请留意微信！');
                    downloadModal.style.display = 'none';
                } else {
                    alert('请输入有效的11位手机号！');
                }
            });
        }

        // 初始化管理员登录模态框
        function initializeAdminLoginModal() {
            const adminLoginModal = document.getElementById('adminLoginModal');
            const closeAdminLoginModal = document.getElementById('closeAdminLoginModal');
            const loginBtn = document.getElementById('loginBtn');
            
            closeAdminLoginModal.addEventListener('click', () => {
                adminLoginModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === adminLoginModal) {
                    adminLoginModal.style.display = 'none';
                }
            });
            
            loginBtn.addEventListener('click', async () => {
                const password = document.getElementById('adminPassword').value;
                if (password === '13572145395') {
                    adminLoginModal.style.display = 'none';
                    document.getElementById('adminSection').style.display = 'block';
                    document.querySelector('.hero-section').style.display = 'none';
                    document.querySelector('.download-section').style.display = 'none';
                    document.querySelector('.form-section').style.display = 'none';
                    await loadAdminData();
                } else {
                    alert('密码错误！');
                }
            });
        }

        // 初始化导出模态框
        function initializeExportModal() {
            const exportModal = document.getElementById('exportModal');
            const closeExportModal = document.getElementById('closeExportModal');
            const exportBtn = document.getElementById('exportBtn');
            const confirmExport = document.getElementById('confirmExport');
            
            exportBtn.addEventListener('click', () => {
                if (!currentQuoteData) {
                    alert('请先生成报价单！');
                    return;
                }
                exportModal.style.display = 'flex';
            });
            
            closeExportModal.addEventListener('click', () => {
                exportModal.style.display = 'none';
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === exportModal) {
                    exportModal.style.display = 'none';
                }
            });
            
            confirmExport.addEventListener('click', () => {
                const level = document.getElementById('exportLevel').value;
                const type = document.getElementById('exportType').value;
                
                exportQuoteToExcel(level, type);
                exportModal.style.display = 'none';
            });
        }

        // 初始化明细展开/收起功能
        function initializeToggleDetails() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('toggle-details')) {
                    const targetId = e.target.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    
                    if (targetElement.style.display === 'block') {
                        targetElement.style.display = 'none';
                        e.target.textContent = '查看明细报价';
                    } else {
                        targetElement.style.display = 'block';
                        e.target.textContent = '收起明细报价';
                    }
                }
            });
        }

        // 初始化页面
        async function initializePage() {
            console.log('初始化页面...');
            await initializeData();
            createFloatingKeywords();
            initializeDownloads();
            initializeAdminPanel();
            initializeDownloadModal();
            initializeAdminLoginModal();
            initializeExportModal();
            initializeToggleDetails();
            
            // 表单提交事件
            document.getElementById('quoteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const community = document.getElementById('community').value;
                const layout = document.getElementById('layout').value;
                const area = parseFloat(document.getElementById('area').value);
                const phone = document.getElementById('phone').value;
                const floorTile = document.getElementById('floorTile').value;
                const wallTile = document.getElementById('wallTile').value;
                const mainLight = document.getElementById('mainLight').checked;
                
                // 验证表单
                if (!community || !layout || !area || !phone) {
                    alert('请填写所有必填字段！');
                    return;
                }
                
                if (area <= 0) {
                    alert('面积必须大于0！');
                    return;
                }
                
                // 验证电话号码
                if (!validatePhone(phone)) {
                    alert('请输入有效的11位手机号码！');
                    return;
                }
                
                // 检查是否已有相同小区和电话的报价
                const existingQuote = await checkExistingQuote(community, phone);
                if (existingQuote) {
                    alert('您已经为该小区查询过报价，请勿重复查询！');
                    return;
                }
                
                // 显示报价
                displayQuote(area, floorTile, wallTile, mainLight);
            });
            
            console.log('页面初始化完成');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
